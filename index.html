<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skull Fuck Terminator</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>💀</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #ffffff; overflow-x: hidden; }
        .container { display: flex; min-height: 100vh; position: relative; width: 100%; }
        .sidebar { width: 280px; background: #111111; padding: 20px; transition: all 0.3s ease; border-right: 1px solid #333; overflow-y: auto; max-height: 100vh; position: fixed; left: 0; top: 0; z-index: 100; scrollbar-width: none; -ms-overflow-style: none; }
        .sidebar::-webkit-scrollbar { width: 0; height: 0; }
        .sidebar.collapsed { left: -280px; }
        .sidebar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .sidebar-title { font-size: 16px; font-weight: 600; }
        .collapse-btn { background: none; border: none; color: #888; cursor: pointer; font-size: 18px; padding: 8px; border-radius: 4px; transition: all 0.3s ease; }
        .collapse-btn:hover { color: #ef4444; background: #222; }
        .day-item { background: #1a1a1a; border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.3s ease; border: 1px solid transparent; }
        .day-item:hover { background: #222; border-color: #333; }
        .day-item.today { border-color: #ef4444; background: #1a0f0f; }
        .day-controls { display: flex; gap: 5px; margin-top: 8px; opacity: 0; transition: opacity 0.3s ease; }
        .day-item:hover .day-controls { opacity: 1; }
        .day-control-btn { background: #333; border: none; border-radius: 4px; padding: 4px 8px; color: #aaa; cursor: pointer; font-size: 10px; transition: all 0.3s ease; }
        .day-control-btn:hover { background: #ef4444; color: #fff; }
        .day-control-btn.delete:hover { background: #dc2626; }
        .day-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .day-date { font-size: 12px; color: #888; margin-bottom: 6px; }
        .day-stats { font-size: 12px; color: #aaa; }
        .cycles-count { color: #ef4444; font-weight: 600; }
        .main-content { flex: 1; padding: 40px; margin-left: 280px; transition: margin-left 0.3s ease; min-height: 100vh; width: calc(100% - 280px); }
        .main-content.sidebar-collapsed { margin-left: 0; width: 100%; }
        .content-wrapper { max-width: 1200px; margin: 0 auto; width: 100%; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 32px; margin-bottom: 8px; }
        .header p { color: #888; font-size: 16px; }
        .timer-section { background: #111111; border-radius: 16px; padding: 40px; text-align: center; margin-bottom: 30px; border: 1px solid #222; }
        .phase-indicator { background: #ef4444; color: #ffffff; padding: 8px 20px; border-radius: 20px; font-size: 14px; font-weight: 600; display: inline-block; margin-bottom: 20px; }
        .timer-display { font-size: 72px; font-weight: 300; letter-spacing: -2px; margin-bottom: 10px; font-family: 'SF Mono', Monaco, monospace; }
        .next-phase { color: #888; font-size: 16px; margin-bottom: 30px; }
        .timer-controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: #ef4444; color: #ffffff; }
        .btn-primary:hover { background: #dc2626; }
        .btn-secondary { background: #333; color: #ffffff; }
        .btn-secondary:hover { background: #444; }
        .keyboard-hints { font-size: 12px; color: #666; }
        .progress-section { background: #111111; border-radius: 16px; padding: 30px; text-align: center; margin-bottom: 30px; border: 1px solid #222; }
        .progress-stats { display: flex; justify-content: center; align-items: center; gap: 40px; margin-bottom: 20px; }
        .stat-group { text-align: center; }
        .stat-number { font-size: 36px; font-weight: 700; color: #ef4444; margin-bottom: 4px; }
        .stat-label { font-size: 14px; color: #888; }
        .progress-bar-container { width: 100%; max-width: 300px; margin: 0 auto; }
        .progress-bar { width: 100%; height: 8px; background: #222; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: #ef4444; border-radius: 4px; transition: width 0.3s ease; }
        .goal-edit { background: none; border: none; color: #ef4444; font-size: 36px; font-weight: 700; width: 60px; text-align: center; cursor: pointer; }
        .goal-edit:focus { outline: 1px solid #ef4444; border-radius: 4px; }
        .tasks-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .task-list { background: #111111; border-radius: 16px; padding: 30px; border: 1px solid #222; }
        .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .task-title { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px; flex: 1; }
        .task-icon { font-size: 16px; }
        .task-action { background: none; border: none; color: #666; cursor: pointer; font-size: 12px; padding: 4px 8px; border-radius: 4px; transition: all 0.3s ease; }
        .task-action:hover { background: #222; color: #ef4444; }
        .add-task { width: 100%; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 12px; color: #ffffff; font-size: 14px; margin-bottom: 20px; }
        .add-task::placeholder { color: #666; }
        .add-task:focus { outline: none; border-color: #ef4444; }
        .task-item { background: #1a1a1a; border-radius: 8px; padding: 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; transition: all 0.3s ease; cursor: pointer; }
        .task-item.completed { background: #0f0f0f; order: 1; }
        .task-checkbox { width: 18px; height: 18px; border: 2px solid #333; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; flex-shrink: 0; }
        .task-checkbox.checked { background: #ef4444; border-color: #ef4444; color: #ffffff; }
        .task-text { flex: 1; font-size: 14px; transition: all 0.3s ease; }
        .task-item.completed .task-text { color: #666; text-decoration: line-through; }
        .task-progress-container { margin-top: 15px; padding-top: 15px; border-top: 1px solid #222; }
        .task-progress-bar { width: 100%; height: 6px; background: #222; border-radius: 3px; overflow: hidden; margin-bottom: 8px; }
        .task-progress-fill { height: 100%; background: #ef4444; border-radius: 3px; transition: width 0.3s ease; }
        .task-progress-text { font-size: 11px; color: #888; text-align: center; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { background: #111111; border-radius: 16px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; border: 1px solid #222; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: 600; }
        .close-btn { background: none; border: none; color: #888; cursor: pointer; font-size: 24px; padding: 5px; }
        .close-btn:hover { color: #ef4444; }
        .config-item { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; }
        .config-input { flex: 1; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 12px; color: #ffffff; font-size: 14px; }
        .config-input:focus { outline: none; border-color: #ef4444; }
        .config-select { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 12px; color: #ffffff; font-size: 14px; cursor: pointer; }
        .delete-btn { background: #ef4444; border: none; border-radius: 6px; padding: 8px 12px; color: #ffffff; cursor: pointer; font-size: 12px; }
        .delete-btn:hover { background: #dc2626; }
        .add-btn { background: #ef4444; border: none; border-radius: 8px; padding: 12px 24px; color: #ffffff; cursor: pointer; font-size: 14px; font-weight: 600; }
        .add-btn:hover { background: #dc2626; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px; }
        .btn-outline { background: none; border: 1px solid #333; color: #ffffff; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .btn-outline:hover { border-color: #ef4444; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-size: 14px; font-weight: 600; }
        .form-input { width: 100%; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 12px; color: #ffffff; font-size: 14px; }
        .form-input:focus { outline: none; border-color: #ef4444; }
        .sidebar-toggle { position: fixed; top: 20px; left: 20px; z-index: 1001; background: #ef4444; border: none; border-radius: 8px; padding: 12px 15px; color: #ffffff; cursor: pointer; font-size: 16px; transition: all 0.3s ease; box-shadow: 0 2px 10px rgba(239, 68, 68, 0.3); }
        .sidebar-toggle:hover { background: #dc2626; transform: translateY(-1px); }
        .notification { position: fixed; top: 20px; right: 20px; background: #111111; border: 1px solid #ef4444; border-radius: 8px; padding: 15px 20px; color: #ffffff; z-index: 1002; max-width: 300px; transform: translateX(100%); transition: transform 0.3s ease; }
        .notification.show { transform: translateX(0); }
        .notification-title { font-weight: 600; margin-bottom: 5px; }
        .notification-body { font-size: 14px; color: #aaa; }
        @media (max-width: 1024px) { .tasks-section { grid-template-columns: 1fr; gap: 20px; } }
        @media (max-width: 768px) { 
            .sidebar { left: -280px; } 
            .sidebar.active { left: 0; } 
            .main-content { margin-left: 0; padding: 80px 15px 20px 15px; width: 100%; } 
            .timer-display { font-size: 48px; } 
            .progress-stats { flex-direction: column; gap: 15px; }
            .sidebar-toggle { left: 20px !important; }
        }
    </style>
</head>
<body>
    <button class="sidebar-toggle" id="sidebar-toggle">📅</button>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3 class="sidebar-title">📅 Histórico Diário</h3>
                <button class="collapse-btn" id="sidebar-collapse-btn">❮</button>
            </div>
            <div id="history-list"></div>
        </div>

        <div class="main-content" id="main-content">
            <div class="content-wrapper">
                <header class="header">
                    <h1>Skull Fuck Terminator</h1>
                    <p>Produtividade. Amplificada.</p>
                </header>

                <section class="timer-section">
                    <div class="phase-indicator" id="phase-indicator">Sessão de Foco</div>
                    <div class="timer-display" id="timer-display">33:33</div>
                    <div class="next-phase" id="next-phase">Próximo: Descanso (6:37)</div>
                    <div class="timer-controls">
                        <button class="btn btn-primary" id="start-btn">▶ Iniciar</button>
                        <button class="btn btn-secondary" id="reset-btn">⏹ Resetar</button>
                        <button class="btn btn-secondary" id="skip-btn">⏭ Pular</button>
                    </div>
                    <div class="keyboard-hints">Pressione <strong>Espaço</strong> para iniciar/pausar • <strong>R</strong> para resetar</div>
                </section>

                <section class="progress-section">
                    <div class="progress-stats">
                        <div class="stat-group">
                            <div class="stat-number" id="cycles-today">0</div>
                            <div class="stat-label">Ciclos Hoje</div>
                        </div>
                        <div style="font-size: 24px; color: #666;">/</div>
                        <div class="stat-group">
                            <input type="number" class="goal-edit" id="goal-edit" value="14" min="1" max="50">
                            <div class="stat-label">Meta</div>
                        </div>
                        <div class="stat-group">
                            <div class="stat-number" id="percentage">0%</div>
                            <div class="stat-label">Completo</div>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
                    </div>
                </section>

                <section class="tasks-section">
                    <div class="task-list">
                        <div class="task-header">
                            <h2 class="task-title"><span class="task-icon">📋</span> Fazer Hoje</h2>
                            <button class="task-action" id="clear-completed-btn">Limpar Concluídas</button>
                        </div>
                        <input type="text" class="add-task" id="add-task-input" placeholder="Adicionar nova tarefa...">
                        <div id="do-today-list"></div>
                        <div class="task-progress-container">
                            <div class="task-progress-bar"><div class="task-progress-fill" id="do-today-progress"></div></div>
                            <div class="task-progress-text" id="do-today-count">0 de 0 concluídas</div>
                        </div>
                    </div>

                    <div class="task-list">
                        <div class="task-header">
                            <h2 class="task-title"><span class="task-icon">⚡</span> Inegociáveis</h2>
                            <button class="task-action" id="config-btn">Configurar</button>
                        </div>
                        <div id="non-negotiables-list"></div>
                        <div class="task-progress-container">
                            <div class="task-progress-bar"><div class="task-progress-fill" id="non-negotiables-progress"></div></div>
                            <div class="task-progress-text" id="non-negotiables-count">0 de 0 concluídos</div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div class="modal" id="edit-day-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="edit-day-modal-title">Editar Dia</h2>
                <button class="close-btn" data-close-modal="edit-day-modal">×</button>
            </div>
            <div class="form">
                <div class="form-group"><label class="form-label">Data</label><input type="date" id="edit-day-date" class="form-input"></div>
                <div class="form-group"><label class="form-label">Ciclos Completos</label><input type="number" id="edit-day-cycles" class="form-input" min="0"></div>
                <div class="form-group"><label class="form-label">Tarefas (uma por linha)</label><textarea id="edit-day-tasks" class="form-input" rows="6"></textarea></div>
            </div>
            <div class="modal-actions">
                <button class="btn-outline" data-close-modal="edit-day-modal">Cancelar</button>
                <button class="btn btn-primary" id="save-day-edit-btn">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <div class="modal" id="config-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Configurar Inegociáveis</h2>
                <button class="close-btn" data-close-modal="config-modal">×</button>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="new-negotiable-input" class="config-input" placeholder="Adicionar novo inegociável...">
                <button class="add-btn" id="add-negotiable-btn">+</button>
            </div>
            <div id="config-list"></div>
            <div class="modal-actions">
                <button class="btn-outline" data-close-modal="config-modal">Cancelar</button>
                <button class="btn btn-primary" id="save-config-btn">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <div class="notification-title" id="notification-title"></div>
        <div class="notification-body" id="notification-body"></div>
    </div>

    <template id="task-item-template">
        <div class="task-item">
            <div class="task-checkbox"></div>
            <div class="task-text"></div>
        </div>
    </template>

    <template id="day-item-template">
        <div class="day-item">
            <div class="day-name"></div>
            <div class="day-date"></div>
            <div class="day-stats"></div>
            <div class="day-controls">
                <button class="day-control-btn edit-btn">Editar</button>
                <button class="day-control-btn delete delete-btn">Deletar</button>
            </div>
        </div>
    </template>
    
    <script>
        'use strict';
        
        // --- APPLICATION STATE ---
        let state = {
            currentTime: 33 * 60 + 33,
            isRunning: false,
            isRestPhase: false,
            timerInterval: null,
            cyclesCompleted: 0,
            dailyGoal: 14,
            doTodayTasks: [],
            nonNegotiables: [],
            nonNegotiablesStatus: {},
            history: {},
            currentEditingDay: null,
            tempNonNegotiables: [],
            audioContext: null,
            isSidebarCollapsed: false
        };

        // Default non-negotiables for new users
        const DEFAULT_NON_NEGOTIABLES = [
            { text: 'Gravar Sonho', frequency: 'daily' },
            { text: 'Sessão de Hipnose', frequency: 'daily' },
            { text: 'Exercício Flash', frequency: 'daily' },
            { text: 'Treino de 30 minutos', frequency: 'daily' },
            { text: 'Alongamento de 15 minutos', frequency: 'daily' },
            { text: 'Liberação Facial', frequency: 'daily' }
        ];
        
        const FOCUS_TIME = 33 * 60 + 33;
        const REST_TIME = 6 * 60 + 37;

        // --- I18N STRINGS ---
        const i18n = {
            start: "▶ Iniciar",
            pause: "⏸ Pausar",
            focusSession: "Sessão de Foco",
            restSession: "Sessão de Descanso",
            nextFocus: `Próximo: Foco (${Math.floor(FOCUS_TIME / 60)}:${(FOCUS_TIME % 60).toString().padStart(2, '0')})`,
            nextRest: `Próximo: Descanso (${Math.floor(REST_TIME / 60)}:${(REST_TIME % 60).toString().padStart(2, '0')})`,
            deleteConfirm: (date) => `Você tem certeza que quer deletar os dados de ${date}?`,
            today: "Hoje",
            yesterday: "Ontem",
        };
        
        // --- DOM ELEMENTS CACHE ---
        const elements = {
            sidebar: document.getElementById('sidebar'),
            mainContent: document.getElementById('main-content'),
            sidebarToggle: document.getElementById('sidebar-toggle'),
            sidebarCollapseBtn: document.getElementById('sidebar-collapse-btn'),
            historyList: document.getElementById('history-list'),
            phaseIndicator: document.getElementById('phase-indicator'),
            timerDisplay: document.getElementById('timer-display'),
            nextPhase: document.getElementById('next-phase'),
            startBtn: document.getElementById('start-btn'),
            resetBtn: document.getElementById('reset-btn'),
            skipBtn: document.getElementById('skip-btn'),
            cyclesToday: document.getElementById('cycles-today'),
            goalEdit: document.getElementById('goal-edit'),
            percentage: document.getElementById('percentage'),
            progressFill: document.getElementById('progress-fill'),
            clearCompletedBtn: document.getElementById('clear-completed-btn'),
            addTaskInput: document.getElementById('add-task-input'),
            doTodayList: document.getElementById('do-today-list'),
            doTodayProgress: document.getElementById('do-today-progress'),
            doTodayCount: document.getElementById('do-today-count'),
            configBtn: document.getElementById('config-btn'),
            nonNegotiablesList: document.getElementById('non-negotiables-list'),
            nonNegotiablesProgress: document.getElementById('non-negotiables-progress'),
            nonNegotiablesCount: document.getElementById('non-negotiables-count'),
            notification: document.getElementById('notification'),
            notificationTitle: document.getElementById('notification-title'),
            notificationBody: document.getElementById('notification-body'),
            editDayModal: {
                modal: document.getElementById('edit-day-modal'),
                title: document.getElementById('edit-day-modal-title'),
                date: document.getElementById('edit-day-date'),
                cycles: document.getElementById('edit-day-cycles'),
                tasks: document.getElementById('edit-day-tasks'),
                saveBtn: document.getElementById('save-day-edit-btn')
            },
            configModal: {
                modal: document.getElementById('config-modal'),
                newInput: document.getElementById('new-negotiable-input'),
                addBtn: document.getElementById('add-negotiable-btn'),
                list: document.getElementById('config-list'),
                saveBtn: document.getElementById('save-config-btn')
            },
            taskTemplate: document.getElementById('task-item-template'),
            dayTemplate: document.getElementById('day-item-template'),
        };

        // --- UTILITY FUNCTIONS ---
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function validateInput(value, min, max, defaultValue) {
            const num = parseInt(value) || defaultValue;
            return Math.max(min, Math.min(max, num));
        }

        function getTodayString() {
            return new Date().toDateString();
        }

        function ensureHistoryExists(dateStr) {
            if (!state.history[dateStr]) {
                state.history[dateStr] = { cycles: 0, doToday: [], nonNegotiables: {} };
            }
        }

        // --- CORE APP LIFECYCLE ---
        function init() {
            loadData();
            checkNewDay(); 
            updateTimerDisplay();
            updateProgress();
            renderAllTasks();
            renderHistory();
            setupEventListeners();
            initSidebar();
            requestNotificationPermission();
        }

        function saveData() {
            try {
                const dataToSave = { 
                    ...state, 
                    timerInterval: null, 
                    tempNonNegotiables: [],
                    audioContext: null
                };
                localStorage.setItem('skull-terminator-data', JSON.stringify(dataToSave));
            } catch (error) {
                console.error('Failed to save data:', error);
                showInAppNotification('Erro', 'Falha ao salvar dados');
            }
        }

        function loadData() {
            try {
                const savedData = localStorage.getItem('skull-terminator-data');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    state = { ...state, ...parsedData };
                    state.isRunning = false;
                    state.timerInterval = null;
                    state.audioContext = null;
                    
                    // Ensure daily goal is at least 14
                    if (state.dailyGoal < 14) {
                        state.dailyGoal = 14;
                    }
                    
                    // If non-negotiables list is empty, add defaults
                    if (!state.nonNegotiables || state.nonNegotiables.length === 0) {
                        state.nonNegotiables = [...DEFAULT_NON_NEGOTIABLES];
                    }
                } else {
                    // First time user - set up default non-negotiables
                    state.nonNegotiables = [...DEFAULT_NON_NEGOTIABLES];
                }
            } catch (error) {
                console.error('Failed to load data:', error);
                showInAppNotification('Erro', 'Falha ao carregar dados salvos');
                // Fallback to defaults for new users
                state.nonNegotiables = [...DEFAULT_NON_NEGOTIABLES];
            }
        }
        
        function checkNewDay() {
            const todayStr = getTodayString();
            ensureHistoryExists(todayStr);
            
            const todayData = state.history[todayStr];
            state.cyclesCompleted = todayData.cycles || 0;
            state.doTodayTasks = todayData.doToday || [];
            state.nonNegotiablesStatus = todayData.nonNegotiables || {};
        }

        function cleanup() {
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
            if (state.audioContext) {
                state.audioContext.close();
                state.audioContext = null;
            }
        }
        
        // --- TIMER FUNCTIONS ---
        function toggleTimer() {
            if (!state.isRunning) {
                startTimer();
            } else {
                pauseTimer();
            }
        }
        
        function startTimer() {
            state.isRunning = true;
            elements.startBtn.innerHTML = i18n.pause;
            state.timerInterval = setInterval(() => {
                state.currentTime--;
                if (state.currentTime < 0) {
                    completePhase();
                } else {
                    updateTimerDisplay();
                }
            }, 1000);
        }

        function pauseTimer() {
            state.isRunning = false;
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
            elements.startBtn.innerHTML = i18n.start;
        }

        function resetTimer() {
            pauseTimer();
            state.currentTime = state.isRestPhase ? REST_TIME : FOCUS_TIME;
            updateTimerDisplay();
        }

        function skipPhase() {
            pauseTimer();
            completePhase();
        }

        function completePhase() {
            const todayStr = getTodayString();
            ensureHistoryExists(todayStr);
            
            playSoundNotification(); 

            if (state.isRestPhase) {
                state.cyclesCompleted++;
                state.history[todayStr].cycles = state.cyclesCompleted;
                state.isRestPhase = false;
                state.currentTime = FOCUS_TIME;
                showNotification('🔥 Ciclo Completo!', `Ótimo! Você completou ${state.cyclesCompleted} ciclos hoje.`);
                showInAppNotification('🔥 Ciclo Completo!', `Ótimo! Você completou ${state.cyclesCompleted} ciclos hoje.`);
            } else {
                state.isRestPhase = true;
                state.currentTime = REST_TIME;
                showNotification('😌 Hora de Descansar!', 'Boa sessão de foco! Faça uma pausa merecida.');
                showInAppNotification('😌 Hora de Descansar!', 'Boa sessão de foco! Faça uma pausa merecida.');
            }
            
            updateTimerDisplay();
            updateProgress();
            renderHistory();
            saveData();
            
            // Don't auto-start next phase - let user decide
            state.isRunning = false;
            elements.startBtn.innerHTML = i18n.start;
        }
        
        // --- AUDIO NOTIFICATION ---
        function initAudioContext() {
            if (!state.audioContext) {
                try {
                    state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (error) {
                    console.warn('Audio context not supported:', error);
                }
            }
        }

        function playSoundNotification() {
            try {
                initAudioContext();
                if (!state.audioContext) return;

                const oscillator = state.audioContext.createOscillator();
                const gainNode = state.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(state.audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, state.audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, state.audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(800, state.audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.3, state.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, state.audioContext.currentTime + 0.3);
                
                oscillator.start(state.audioContext.currentTime);
                oscillator.stop(state.audioContext.currentTime + 0.3);
            } catch (error) {
                console.warn('Failed to play sound:', error);
            }
        }
        
        // --- RENDER & DISPLAY FUNCTIONS ---
        function updateTimerDisplay() {
            const timeString = formatTime(state.currentTime);
            elements.timerDisplay.textContent = timeString;
            document.title = `${timeString} - ${state.isRestPhase ? i18n.restSession : i18n.focusSession}`;
            elements.phaseIndicator.textContent = state.isRestPhase ? i18n.restSession : i18n.focusSession;
            elements.nextPhase.textContent = state.isRestPhase ? i18n.nextFocus : i18n.nextRest;
        }

        function updateProgress() {
            elements.cyclesToday.textContent = state.cyclesCompleted;
            elements.goalEdit.value = state.dailyGoal;
            
            const percentage = state.dailyGoal > 0 ? Math.round((state.cyclesCompleted / state.dailyGoal) * 100) : 0;
            const displayPercentage = Math.min(percentage, 100);
            
            elements.percentage.textContent = `${percentage}%`;
            elements.progressFill.style.width = `${displayPercentage}%`;
        }
        
        function renderAllTasks() {
            renderDoToday();
            renderNonNegotiables();
        }
        
        function renderTask(container, tasks, isCompletedFn, template, useTextAsId = false) {
            container.innerHTML = '';
            const sortedTasks = [...tasks].sort((a, b) => isCompletedFn(a) - isCompletedFn(b));
            
            sortedTasks.forEach(task => {
                const taskClone = template.content.cloneNode(true);
                const taskItem = taskClone.querySelector('.task-item');
                const checkbox = taskClone.querySelector('.task-checkbox');
                const text = taskClone.querySelector('.task-text');
                
                const completed = isCompletedFn(task);
                taskItem.classList.toggle('completed', completed);
                taskItem.dataset.id = useTextAsId ? task.text : (task.id || task.text);
                checkbox.classList.toggle('checked', completed);
                checkbox.innerHTML = completed ? '✓' : '';
                text.textContent = task.text;
                
                container.appendChild(taskClone);
            });
        }

        function renderDoToday() {
            renderTask(elements.doTodayList, state.doTodayTasks, task => task.completed, elements.taskTemplate, false);
            updateTaskProgress(elements.doTodayCount, elements.doTodayProgress, state.doTodayTasks, task => task.completed);
        }

        function renderNonNegotiables() {
            renderTask(elements.nonNegotiablesList, state.nonNegotiables, item => !!state.nonNegotiablesStatus[item.text], elements.taskTemplate, true);
            updateTaskProgress(elements.nonNegotiablesCount, elements.nonNegotiablesProgress, state.nonNegotiables, item => !!state.nonNegotiablesStatus[item.text]);
        }

        function updateTaskProgress(countEl, progressEl, tasks, isCompletedFn) {
            const total = tasks.length;
            const completed = tasks.filter(isCompletedFn).length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            countEl.textContent = `${completed} de ${total} concluídas`;
            progressEl.style.width = `${percentage}%`;
        }

        // --- TASK MANAGEMENT ---
        function addDoTodayTask() {
            const text = elements.addTaskInput.value.trim();
            if (text && text.length <= 200) {
                const todayStr = getTodayString();
                ensureHistoryExists(todayStr);
                
                state.doTodayTasks.push({ id: generateUniqueId(), text, completed: false });
                state.history[todayStr].doToday = state.doTodayTasks;
                elements.addTaskInput.value = '';
                renderDoToday();
                saveData();
            }
        }
        
        function toggleDoTodayTask(taskId) {
            const task = state.doTodayTasks.find(t => t.id === taskId);
            if (task) {
                const todayStr = getTodayString();
                ensureHistoryExists(todayStr);
                
                task.completed = !task.completed;
                if (task.completed) {
                    showNotification('✅ Tarefa Concluída!', `"${task.text}" - Bom trabalho!`);
                    showInAppNotification('✅ Tarefa Concluída!', `"${task.text}" - Bom trabalho!`);
                }
                state.history[todayStr].doToday = state.doTodayTasks;
                renderDoToday();
                saveData();
            }
        }
        
        function toggleNonNegotiable(text) {
            const todayStr = getTodayString();
            ensureHistoryExists(todayStr);
            
            state.nonNegotiablesStatus[text] = !state.nonNegotiablesStatus[text];
            if (state.nonNegotiablesStatus[text]) {
                showNotification('⚡ Inegociável Feito!', `"${text}" - Você é imparável!`);
                showInAppNotification('⚡ Inegociável Feito!', `"${text}" - Você é imparável!`);
            }
            state.history[todayStr].nonNegotiables = state.nonNegotiablesStatus;
            renderNonNegotiables();
            saveData();
        }
        
        function clearCompletedTasks() {
            const todayStr = getTodayString();
            ensureHistoryExists(todayStr);
            
            state.doTodayTasks = state.doTodayTasks.filter(task => !task.completed);
            state.history[todayStr].doToday = state.doTodayTasks;
            renderDoToday();
            saveData();
        }
        
        // --- HISTORY MANAGEMENT ---
        function renderHistory() {
            elements.historyList.innerHTML = '';
            const sortedDays = Object.keys(state.history).sort((a, b) => new Date(b) - new Date(a));
            
            sortedDays.forEach(dateStr => {
                const dayData = state.history[dateStr];
                const clone = elements.dayTemplate.content.cloneNode(true);
                const item = clone.querySelector('.day-item');
                const name = clone.querySelector('.day-name');
                const dateEl = clone.querySelector('.day-date');
                const stats = clone.querySelector('.day-stats');
                const editBtn = clone.querySelector('.edit-btn');
                const deleteBtn = clone.querySelector('.delete-btn');
                
                const date = new Date(dateStr);
                const today = new Date();
                const isToday = date.toDateString() === today.toDateString();
                
                item.dataset.dateStr = dateStr;
                item.classList.toggle('today', isToday);
                
                const dayDiff = Math.round((new Date(today.toDateString()) - new Date(date.toDateString())) / (1000 * 60 * 60 * 24));

                if (dayDiff === 0) name.textContent = i18n.today;
                else if (dayDiff === 1) name.textContent = i18n.yesterday;
                else name.textContent = date.toLocaleDateString('pt-BR', { month: 'short', day: 'numeric' });

                dateEl.textContent = date.toLocaleDateString('pt-BR');
                stats.innerHTML = `<span class="cycles-count">${dayData.cycles || 0}</span> ciclos`;
                
                if (isToday) {
                    deleteBtn.style.display = 'none';
                }
                
                elements.historyList.appendChild(clone);
            });
        }

        function deleteDay(dateStr) {
            const date = new Date(dateStr).toLocaleDateString('pt-BR');
            if (confirm(i18n.deleteConfirm(date))) {
                delete state.history[dateStr];
                saveData();
                renderHistory();
            }
        }
        
        // --- MODAL FUNCTIONS ---
        function openModal(modalEl) { 
            modalEl.classList.add('active'); 
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal(modalEl) { 
            modalEl.classList.remove('active'); 
            document.body.style.overflow = '';
        }
        
        function editDay(dateStr) {
            state.currentEditingDay = dateStr;
            ensureHistoryExists(dateStr);
            const dayData = state.history[dateStr];
            const date = new Date(dateStr);
            
            elements.editDayModal.title.textContent = `Editar ${date.toLocaleDateString('pt-BR')}`;
            elements.editDayModal.date.value = date.toISOString().split('T')[0];
            elements.editDayModal.cycles.value = dayData.cycles || 0;
            elements.editDayModal.tasks.value = (dayData.doToday || []).map(t => t.text).join('\n');
            
            openModal(elements.editDayModal.modal);
        }

        function saveDayEdit() {
            if (!state.currentEditingDay) return;
            
            const oldDateStr = state.currentEditingDay;
            const newDate = new Date(elements.editDayModal.date.value + 'T00:00:00');
            const newDateStr = newDate.toDateString();
            
            const oldTasks = state.history[oldDateStr]?.doToday || [];
            const newTasksText = elements.editDayModal.tasks.value.trim().split('\n').filter(Boolean);
            
            const updatedTasks = newTasksText.map(text => {
                const existingTask = oldTasks.find(t => t.text === text);
                return existingTask || { id: generateUniqueId(), text, completed: false };
            });

            const cycles = validateInput(elements.editDayModal.cycles.value, 0, 100, 0);

            const newDayData = {
                cycles: cycles,
                doToday: updatedTasks,
                nonNegotiables: state.history[oldDateStr]?.nonNegotiables || {}
            };

            if (oldDateStr !== newDateStr) {
                delete state.history[oldDateStr];
            }
            state.history[newDateStr] = newDayData;
            
            if (newDateStr === getTodayString()) {
                checkNewDay(); 
                updateProgress();
                renderAllTasks();
            }
            
            saveData();
            renderHistory();
            closeModal(elements.editDayModal.modal);
            state.currentEditingDay = null;
        }
        
        function openConfigModal() {
            state.tempNonNegotiables = JSON.parse(JSON.stringify(state.nonNegotiables));
            renderConfigModal();
            openModal(elements.configModal.modal);
        }

        function renderConfigModal() {
            elements.configModal.list.innerHTML = '';
            state.tempNonNegotiables.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'config-item';
                div.innerHTML = `
                    <input type="text" class="config-input" value="${item.text}" data-index="${index}" maxlength="100">
                    <select class="config-select" data-index="${index}">
                        <option value="daily" ${item.frequency === 'daily' ? 'selected' : ''}>Diário</option>
                        <option value="weekdays" ${item.frequency === 'weekdays' ? 'selected' : ''}>Dias de semana</option>
                    </select>
                    <button class="delete-btn" data-index="${index}">🗑</button>
                `;
                elements.configModal.list.appendChild(div);
            });
        }
        
        function addTempNonNegotiable() {
            const text = elements.configModal.newInput.value.trim();
            if (text && text.length <= 100) {
                state.tempNonNegotiables.push({ text, frequency: 'daily' });
                elements.configModal.newInput.value = '';
                renderConfigModal();
            }
        }
        
        function saveConfiguration() {
            state.nonNegotiables = state.tempNonNegotiables.filter(item => item.text.trim());
            state.tempNonNegotiables = [];
            closeModal(elements.configModal.modal);
            renderNonNegotiables();
            saveData();
        }
        
        // --- SIDEBAR & NOTIFICATIONS ---
        function toggleSidebar() {
            const { sidebar, mainContent, sidebarToggle } = elements;
            
            if (window.innerWidth > 768) {
                const isCollapsed = sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('sidebar-collapsed', isCollapsed);
                state.isSidebarCollapsed = isCollapsed;
                
                sidebarToggle.innerHTML = isCollapsed ? '📅' : '❮';
                sidebarToggle.style.left = isCollapsed ? '20px' : '300px';
            } else {
                const isActive = sidebar.classList.toggle('active');
                sidebarToggle.innerHTML = isActive ? '❮' : '📅';
            }
            saveData();
        }
        
        function initSidebar() {
            const { sidebar, mainContent, sidebarToggle } = elements;
            
            if (window.innerWidth > 768) {
                sidebar.classList.toggle('collapsed', state.isSidebarCollapsed);
                sidebar.classList.remove('active');
                mainContent.classList.toggle('sidebar-collapsed', state.isSidebarCollapsed);
                sidebarToggle.innerHTML = state.isSidebarCollapsed ? '📅' : '❮';
                sidebarToggle.style.left = state.isSidebarCollapsed ? '20px' : '300px';
            } else {
                sidebar.classList.add('collapsed');
                sidebar.classList.remove('active');
                mainContent.classList.add('sidebar-collapsed');
                sidebarToggle.innerHTML = '📅';
                sidebarToggle.style.left = '20px';
            }
        }
        
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showInAppNotification('Notificações Ativadas!', 'Você será notificado ao final de cada ciclo.');
                    }
                });
            }
        }

        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                try {
                    new Notification(title, { 
                        body, 
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">💀</text></svg>',
                        silent: false
                    });
                } catch (error) {
                    console.warn('Failed to show notification:', error);
                }
            }
        }

        function showInAppNotification(title, body) {
            elements.notificationTitle.textContent = title;
            elements.notificationBody.textContent = body;
            elements.notification.classList.add('show');
            
            setTimeout(() => {
                elements.notification.classList.remove('show');
            }, 4000);
        }
        
        // --- EVENT LISTENERS SETUP ---
        function setupEventListeners() {
            // Timer controls
            elements.startBtn.addEventListener('click', toggleTimer);
            elements.resetBtn.addEventListener('click', resetTimer);
            elements.skipBtn.addEventListener('click', skipPhase);

            // Task controls
            elements.addTaskInput.addEventListener('keypress', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addDoTodayTask();
                }
            });
            elements.clearCompletedBtn.addEventListener('click', clearCompletedTasks);
            elements.configBtn.addEventListener('click', openConfigModal);

            // Progress goal
            elements.goalEdit.addEventListener('change', () => {
                state.dailyGoal = validateInput(elements.goalEdit.value, 14, 50, 14);
                elements.goalEdit.value = state.dailyGoal;
                updateProgress();
                saveData();
            });
            
            // Sidebar controls
            elements.sidebarToggle.addEventListener('click', toggleSidebar);
            elements.sidebarCollapseBtn.addEventListener('click', toggleSidebar);

            // Modals
            elements.editDayModal.saveBtn.addEventListener('click', saveDayEdit);
            elements.configModal.addBtn.addEventListener('click', addTempNonNegotiable);
            elements.configModal.newInput.addEventListener('keypress', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addTempNonNegotiable();
                }
            });
            elements.configModal.saveBtn.addEventListener('click', saveConfiguration);
            
            // Event delegation for dynamic content
            elements.doTodayList.addEventListener('click', e => {
                const taskItem = e.target.closest('.task-item');
                if (taskItem) toggleDoTodayTask(taskItem.dataset.id);
            });
            
            elements.nonNegotiablesList.addEventListener('click', e => {
                const taskItem = e.target.closest('.task-item');
                if (taskItem) toggleNonNegotiable(taskItem.dataset.id);
            });
            
            elements.historyList.addEventListener('click', e => {
                const dayItem = e.target.closest('.day-item');
                if (!dayItem) return;
                
                const dateStr = dayItem.dataset.dateStr;
                if (!dateStr) return;
                
                if (e.target.closest('.edit-btn')) {
                    editDay(dateStr);
                } else if (e.target.closest('.delete-btn')) {
                    deleteDay(dateStr);
                }
            });
            
            elements.configModal.list.addEventListener('click', e => {
                const index = parseInt(e.target.dataset.index);
                if (isNaN(index)) return;
                
                if (e.target.matches('.delete-btn')) {
                    state.tempNonNegotiables.splice(index, 1);
                    renderConfigModal();
                }
            });
            
            elements.configModal.list.addEventListener('change', e => {
                const index = parseInt(e.target.dataset.index);
                if (isNaN(index) || !state.tempNonNegotiables[index]) return;
                
                if (e.target.matches('.config-input')) {
                    state.tempNonNegotiables[index].text = e.target.value.trim();
                } else if (e.target.matches('.config-select')) {
                    state.tempNonNegotiables[index].frequency = e.target.value;
                }
            });

            // Generic modal close listeners
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', e => {
                    if (e.target === modal || e.target.closest(`[data-close-modal="${modal.id}"]`)) {
                        closeModal(modal);
                    }
                });
            });

            // Notification click to dismiss
            elements.notification.addEventListener('click', () => {
                elements.notification.classList.remove('show');
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', e => {
                if (document.activeElement.tagName === 'INPUT' || 
                    document.activeElement.tagName === 'TEXTAREA' ||
                    document.querySelector('.modal.active')) {
                    return;
                }
                
                if (e.code === 'Space') { 
                    e.preventDefault(); 
                    toggleTimer(); 
                }
                if (e.code === 'KeyR') { 
                    e.preventDefault(); 
                    resetTimer(); 
                }
                if (e.code === 'KeyS') {
                    e.preventDefault();
                    skipPhase();
                }
                if (e.code === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        closeModal(modal);
                    });
                }
            });

            // Auto-save and cleanup
            window.addEventListener('beforeunload', () => {
                saveData();
                cleanup();
            });
            
            // Periodic checks
            setInterval(checkNewDay, 60000); // Check for new day every minute
            setInterval(saveData, 30000); // Auto-save every 30 seconds
            
            // Responsive sidebar
            window.addEventListener('resize', initSidebar);
            
            // Handle visibility change for timer
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible' && state.isRunning) {
                    // Verify timer is still running when tab becomes visible
                    if (!state.timerInterval) {
                        startTimer();
                    }
                }
            });
        }

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', init);
        
        // Prevent context menu on production
        if (window.location.protocol !== 'file:') {
            document.addEventListener('contextmenu', e => e.preventDefault());
        }
    </script>
</body>
</html>

        