<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skull Fuck Terminator</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>💀</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #0a0a0a;
            color: #ffffff; 
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(220, 38, 38, 0.5);
            color: #dc2626;
        }
        
        .timer-section {
            background: #1a1a1a;
            border: 2px solid #dc2626;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 0 40px rgba(220, 38, 38, 0.2);
        }
        
        .phase-indicator {
            background: #dc2626;
            color: #ffffff;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        .timer-display {
            font-size: 84px;
            font-weight: 300;
            letter-spacing: -2px;
            margin-bottom: 10px;
            font-family: 'SF Mono', Monaco, monospace;
            color: #dc2626;
            text-shadow: 0 0 30px rgba(220, 38, 38, 0.5);
        }
        
        .cycles-display {
            font-size: 18px;
            margin-bottom: 20px;
            opacity: 0.9;
        }
        
        .cycles-number {
            font-size: 24px;
            font-weight: 700;
            margin-left: 8px;
            color: #dc2626;
        }
        
        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 12px 28px;
            border: 2px solid #333;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #1a1a1a;
            color: white;
        }
        
        .btn:hover {
            background: #2a2a2a;
            border-color: #dc2626;
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: #dc2626;
            border-color: #dc2626;
            color: white;
        }
        
        .btn-primary:hover {
            background: #b91c1c;
        }
        
        .keyboard-hints {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .tasks-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .task-panel {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 20px;
            padding: 24px;
        }
        
        .task-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .task-panel h2 {
            color: #dc2626;
            font-size: 18px;
            font-weight: 600;
        }
        
        .settings-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
            transition: all 0.3s ease;
        }
        
        .settings-btn:hover {
            color: #dc2626;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: #0a0a0a;
            padding: 4px;
            border-radius: 12px;
        }
        
        .tab {
            flex: 1;
            padding: 8px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: #dc2626;
            color: white;
        }
        
        .task-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .task-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #333;
            border-radius: 12px;
            font-size: 14px;
            color: #fff;
            background: #0a0a0a;
            transition: all 0.3s ease;
        }
        
        .task-input:focus {
            outline: none;
            border-color: #dc2626;
        }
        
        .priority-select {
            padding: 12px;
            border: 2px solid #333;
            border-radius: 12px;
            font-size: 14px;
            color: #fff;
            cursor: pointer;
            background: #0a0a0a;
        }
        
        .add-task-btn {
            padding: 12px 20px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .add-task-btn:hover {
            background: #b91c1c;
        }
        
        .task-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .task-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .task-item:hover {
            border-color: #dc2626;
        }
        
        .task-item:hover .task-actions {
            opacity: 1;
        }
        
        .task-item.completed {
            opacity: 0.5;
        }
        
        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #666;
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
            cursor: pointer;
        }
        
        .task-checkbox.checked {
            background: #dc2626;
            border-color: #dc2626;
        }
        
        .task-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 12px;
        }
        
        .task-text {
            flex: 1;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
        }
        
        .task-item.completed .task-text {
            text-decoration: line-through;
            color: #666;
        }
        
        .priority-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .priority-badge:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.5);
        }
        
        .priority-p1 {
            background: #dc2626;
            color: white;
        }
        
        .priority-p2 {
            background: #ea580c;
            color: white;
        }
        
        .priority-p3 {
            background: #ca8a04;
            color: white;
        }
        
        .task-actions {
            display: flex;
            gap: 5px;
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .task-action-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .task-action-btn:hover {
            color: #dc2626;
        }
        
        .non-negotiable-item {
            display: flex;
            align-items: center;
            padding: 14px;
            margin-bottom: 10px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .non-negotiable-item:hover {
            border-color: #dc2626;
        }
        
        .non-negotiable-item.completed {
            opacity: 0.5;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: #1a1a1a;
            border: 2px solid #dc2626;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            color: #dc2626;
            font-size: 20px;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        
        .close-btn:hover {
            color: #dc2626;
        }
        
        .modal-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #333;
            border-radius: 12px;
            font-size: 14px;
            color: #fff;
            background: #0a0a0a;
            margin-bottom: 15px;
        }
        
        .modal-input:focus {
            outline: none;
            border-color: #dc2626;
        }
        
        .modal-btn {
            width: 100%;
            padding: 14px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .modal-btn:hover {
            background: #b91c1c;
        }
        
        .modal-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 12px;
            margin-bottom: 8px;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #dc2626;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
        }
        
        .move-modal-content {
            text-align: center;
        }
        
        .move-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .move-option-btn {
            padding: 14px;
            background: #0a0a0a;
            border: 2px solid #333;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .move-option-btn:hover {
            border-color: #dc2626;
            background: #1a1a1a;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1a1a1a;
            border: 2px solid #dc2626;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 0 40px rgba(220, 38, 38, 0.3);
            transform: translateX(calc(100% + 40px));
            transition: transform 0.3s ease;
            max-width: 320px;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-title {
            color: #dc2626;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .notification-body {
            color: #fff;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .tasks-container {
                grid-template-columns: 1fr;
            }
            
            .timer-display {
                font-size: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>💀 Skull Fuck Terminator</h1>
        </header>
        
        <section class="timer-section">
            <div class="phase-indicator" id="phase-indicator">Sessão de Foco</div>
            <div class="timer-display" id="timer-display">33:33</div>
            <div class="cycles-display">
                Ciclos Hoje: <span class="cycles-number" id="cycles-today">0</span>
            </div>
            <div class="timer-controls">
                <button class="btn btn-primary" id="start-btn">▶ Iniciar</button>
                <button class="btn" id="reset-btn">⏹ Resetar</button>
                <button class="btn" id="skip-btn">⏭ Pular</button>
            </div>
            <div class="keyboard-hints">Pressione <strong>Espaço</strong> para iniciar/pausar • <strong>R</strong> para resetar</div>
        </section>
        
        <div class="tasks-container">
            <div class="task-panel">
                <h2>Tasks</h2>
                <div class="tabs">
                    <button class="tab active" data-tab="today">Today</button>
                    <button class="tab" data-tab="tomorrow">Tomorrow</button>
                    <button class="tab" data-tab="backlog">Backlog</button>
                </div>
                <div class="task-input-container">
                    <input type="text" class="task-input" id="task-input" placeholder="Add a new task...">
                    <select class="priority-select" id="priority-select">
                        <option value="p1">P1</option>
                        <option value="p2">P2</option>
                        <option value="p3">P3</option>
                    </select>
                    <button class="add-task-btn" id="add-task-btn">+</button>
                </div>
                <div class="task-list" id="task-list"></div>
            </div>
            
            <div class="task-panel">
                <div class="task-panel-header">
                    <h2>Non-Negotiables</h2>
                    <button class="settings-btn" id="settings-btn">⚙️</button>
                </div>
                <div class="task-list" id="non-negotiables-list"></div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Manage Non-Negotiables</h3>
                <button class="close-btn" id="close-modal">×</button>
            </div>
            <input type="text" class="modal-input" id="modal-input" placeholder="Add non-negotiable...">
            <button class="modal-btn" id="modal-add-btn">+ Add Non-Negotiable</button>
            <div id="modal-list"></div>
        </div>
    </div>
    
    <div class="modal" id="move-modal">
        <div class="modal-content move-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Move Task To</h3>
                <button class="close-btn" id="close-move-modal">×</button>
            </div>
            <div class="move-options">
                <button class="move-option-btn" data-target="today">📅 Today</button>
                <button class="move-option-btn" data-target="tomorrow">⏰ Tomorrow</button>
                <button class="move-option-btn" data-target="backlog">📋 Backlog</button>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification">
        <div class="notification-title" id="notification-title"></div>
        <div class="notification-body" id="notification-body"></div>
    </div>
    
    <script>
        'use strict';
        
        // State Management
        let state = {
            currentTime: 33 * 60 + 33,
            isRunning: false,
            isRestPhase: false,
            timerInterval: null,
            cyclesCompleted: 0,
            activeTab: 'today',
            tasks: {
                today: [],
                tomorrow: [],
                backlog: []
            },
            nonNegotiables: [
                { id: '1', text: 'Acquisition Work (Reels, Stories, DM\'s, Ads)', completed: false },
                { id: '2', text: 'Product Work (Study & Develop)', completed: false },
                { id: '3', text: 'Meditation', completed: false },
                { id: '4', text: 'Workout', completed: false }
            ],
            audioContext: null,
            currentMovingTaskId: null
        };
        
        const FOCUS_TIME = 33 * 60 + 33;
        const REST_TIME = 6 * 60 + 37;
        const PRIORITY_ORDER = { p1: 1, p2: 2, p3: 3 };
        
        // DOM Elements
        const elements = {
            phaseIndicator: document.getElementById('phase-indicator'),
            timerDisplay: document.getElementById('timer-display'),
            cyclesToday: document.getElementById('cycles-today'),
            startBtn: document.getElementById('start-btn'),
            resetBtn: document.getElementById('reset-btn'),
            skipBtn: document.getElementById('skip-btn'),
            taskInput: document.getElementById('task-input'),
            prioritySelect: document.getElementById('priority-select'),
            addTaskBtn: document.getElementById('add-task-btn'),
            taskList: document.getElementById('task-list'),
            nonNegotiablesList: document.getElementById('non-negotiables-list'),
            notification: document.getElementById('notification'),
            notificationTitle: document.getElementById('notification-title'),
            notificationBody: document.getElementById('notification-body'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            closeModal: document.getElementById('close-modal'),
            modalInput: document.getElementById('modal-input'),
            modalAddBtn: document.getElementById('modal-add-btn'),
            modalList: document.getElementById('modal-list'),
            moveModal: document.getElementById('move-modal'),
            closeMoveModal: document.getElementById('close-move-modal')
        };
        
        // Initialize
        function init() {
            loadData();
            checkNewDay();
            updateTimerDisplay();
            updateCyclesDisplay();
            renderTasks();
            renderNonNegotiables();
            setupEventListeners();
            requestNotificationPermission();
            scheduleNextMidnightCheck();
        }
        
        // Data Persistence
        function saveData() {
            try {
                const dataToSave = {
                    currentTime: state.currentTime,
                    isRestPhase: state.isRestPhase,
                    cyclesCompleted: state.cyclesCompleted,
                    activeTab: state.activeTab,
                    tasks: state.tasks,
                    nonNegotiables: state.nonNegotiables
                };
                localStorage.setItem('skull_terminator_data', JSON.stringify(dataToSave));
            } catch (error) {
                console.error('Failed to save data:', error);
            }
        }
        
        function loadData() {
            try {
                const savedData = localStorage.getItem('skull_terminator_data');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    state.currentTime = parsedData.currentTime || state.currentTime;
                    state.isRestPhase = parsedData.isRestPhase || false;
                    state.cyclesCompleted = parsedData.cyclesCompleted || 0;
                    state.activeTab = parsedData.activeTab || 'today';
                    state.tasks = parsedData.tasks || state.tasks;
                    state.nonNegotiables = parsedData.nonNegotiables || state.nonNegotiables;
                }
            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }
        
        function checkNewDay() {
            const now = new Date();
            const today = now.toDateString();
            const savedDate = localStorage.getItem('skull_last_date');
            
            if (savedDate !== today) {
                // Delete completed tasks from today
                state.tasks.today = state.tasks.today.filter(task => !task.completed);
                
                // Move tomorrow tasks to today
                state.tasks.today = [...state.tasks.today, ...state.tasks.tomorrow];
                state.tasks.tomorrow = [];
                
                // Reset cycle count
                state.cyclesCompleted = 0;
                
                // Reset non-negotiables
                state.nonNegotiables.forEach(item => item.completed = false);
                
                localStorage.setItem('skull_last_date', today);
                saveData();
                
                // Re-render everything
                updateCyclesDisplay();
                renderTasks();
                renderNonNegotiables();
            }
        }
        
        function scheduleNextMidnightCheck() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            
            const timeUntilMidnight = tomorrow.getTime() - now.getTime();
            
            setTimeout(() => {
                checkNewDay();
                scheduleNextMidnightCheck();
            }, timeUntilMidnight);
        }
        
        // Timer Functions
        function toggleTimer() {
            if (!state.isRunning) {
                startTimer();
            } else {
                pauseTimer();
            }
        }
        
        function startTimer() {
            state.isRunning = true;
            elements.startBtn.innerHTML = '⏸ Pausar';
            state.timerInterval = setInterval(() => {
                state.currentTime--;
                if (state.currentTime < 0) {
                    completePhase();
                } else {
                    updateTimerDisplay();
                }
            }, 1000);
        }
        
        function pauseTimer() {
            state.isRunning = false;
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
            elements.startBtn.innerHTML = '▶ Iniciar';
        }
        
        function resetTimer() {
            pauseTimer();
            state.currentTime = state.isRestPhase ? REST_TIME : FOCUS_TIME;
            updateTimerDisplay();
        }
        
        function skipPhase() {
            pauseTimer();
            completePhase();
        }
        
        function completePhase() {
            playSoundNotification();
            
            if (state.isRestPhase) {
                state.cyclesCompleted++;
                state.isRestPhase = false;
                state.currentTime = FOCUS_TIME;
                showNotification('🔥 Ciclo Completo!', `${state.cyclesCompleted} ciclos completados hoje!`);
            } else {
                state.isRestPhase = true;
                state.currentTime = REST_TIME;
                showNotification('😌 Hora de Descansar!', 'Faça uma pausa merecida.');
            }
            
            updateTimerDisplay();
            updateCyclesDisplay();
            saveData();
            
            state.isRunning = false;
            elements.startBtn.innerHTML = '▶ Iniciar';
        }
        
        // Display Updates
        function updateTimerDisplay() {
            const minutes = Math.floor(state.currentTime / 60);
            const seconds = state.currentTime % 60;
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            elements.timerDisplay.textContent = timeString;
            document.title = `${timeString} - ${state.isRestPhase ? 'Descanso' : 'Foco'}`;
            elements.phaseIndicator.textContent = state.isRestPhase ? 'Sessão de Descanso' : 'Sessão de Foco';
        }
        
        function updateCyclesDisplay() {
            elements.cyclesToday.textContent = state.cyclesCompleted;
        }
        
        // Task Management
        function addTask() {
            const text = elements.taskInput.value.trim();
            if (!text) return;
            
            const task = {
                id: Date.now().toString(),
                text: text,
                priority: elements.prioritySelect.value,
                completed: false
            };
            
            state.tasks[state.activeTab].push(task);
            elements.taskInput.value = '';
            renderTasks();
            saveData();
        }
        
        function toggleTask(taskId) {
            const task = state.tasks[state.activeTab].find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                if (task.completed) {
                    showNotification('✅ Task Complete!', task.text);
                }
                renderTasks();
                saveData();
            }
        }
        
        function deleteTask(taskId) {
            state.tasks[state.activeTab] = state.tasks[state.activeTab].filter(t => t.id !== taskId);
            renderTasks();
            saveData();
        }
        
        function changePriority(taskId) {
            const task = state.tasks[state.activeTab].find(t => t.id === taskId);
            if (!task) return;
            
            // Cycle through priorities: P1 -> P2 -> P3 -> P1
            const priorities = ['p1', 'p2', 'p3'];
            const currentIndex = priorities.indexOf(task.priority);
            const nextIndex = (currentIndex + 1) % priorities.length;
            task.priority = priorities[nextIndex];
            
            renderTasks();
            saveData();
        }
        
        function openMoveModal(taskId) {
            state.currentMovingTaskId = taskId;
            elements.moveModal.classList.add('show');
        }
        
        function closeMoveModal() {
            elements.moveModal.classList.remove('show');
            state.currentMovingTaskId = null;
        }
        
        function moveTaskTo(targetTab) {
            if (!state.currentMovingTaskId) return;
            
            const fromTab = state.activeTab;
            if (fromTab === targetTab) {
                closeMoveModal();
                return;
            }
            
            const taskIndex = state.tasks[fromTab].findIndex(t => t.id === state.currentMovingTaskId);
            if (taskIndex !== -1) {
                const [task] = state.tasks[fromTab].splice(taskIndex, 1);
                state.tasks[targetTab].push(task);
                renderTasks();
                saveData();
                showNotification('📋 Task Moved!', `Moved to ${targetTab}`);
            }
            
            closeMoveModal();
        }
        
        function renderTasks() {
            elements.taskList.innerHTML = '';
            const tasks = state.tasks[state.activeTab] || [];
            
            // Sort by priority (P1, P2, P3) and completion status
            const sortedTasks = [...tasks].sort((a, b) => {
                if (a.completed !== b.completed) {
                    return a.completed ? 1 : -1;
                }
                return PRIORITY_ORDER[a.priority] - PRIORITY_ORDER[b.priority];
            });
            
            sortedTasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = `task-item ${task.completed ? 'completed' : ''}`;
                taskEl.dataset.id = task.id;
                
                taskEl.innerHTML = `
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" data-action="toggle"></div>
                    <span class="task-text" data-action="toggle">${task.text}</span>
                    <span class="priority-badge priority-${task.priority}" data-action="priority">${task.priority.toUpperCase()}</span>
                    <div class="task-actions">
                        <button class="task-action-btn move-btn" data-action="move" title="Move task">📋</button>
                        <button class="task-action-btn delete-task-btn" data-action="delete" title="Delete task">🗑️</button>
                    </div>
                `;
                
                elements.taskList.appendChild(taskEl);
            });
        }
        
        // Non-Negotiables Management
        function addNonNegotiable() {
            const text = elements.modalInput.value.trim();
            if (!text) return;
            
            const item = {
                id: Date.now().toString(),
                text: text,
                completed: false
            };
            
            state.nonNegotiables.push(item);
            elements.modalInput.value = '';
            renderNonNegotiables();
            renderModalList();
            saveData();
        }
        
        function deleteNonNegotiable(itemId) {
            state.nonNegotiables = state.nonNegotiables.filter(n => n.id !== itemId);
            renderNonNegotiables();
            renderModalList();
            saveData();
        }
        
        function toggleNonNegotiable(itemId) {
            const item = state.nonNegotiables.find(n => n.id === itemId);
            if (item) {
                item.completed = !item.completed;
                if (item.completed) {
                    showNotification('⚡ Non-Negotiable Done!', item.text);
                }
                renderNonNegotiables();
                saveData();
            }
        }
        
        function renderNonNegotiables() {
            elements.nonNegotiablesList.innerHTML = '';
            
            const sortedItems = [...state.nonNegotiables].sort((a, b) => {
                if (a.completed === b.completed) return 0;
                return a.completed ? 1 : -1;
            });
            
            sortedItems.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = `non-negotiable-item ${item.completed ? 'completed' : ''}`;
                itemEl.dataset.id = item.id;
                
                itemEl.innerHTML = `
                    <div class="task-checkbox ${item.completed ? 'checked' : ''}"></div>
                    <span class="task-text">${item.text}</span>
                `;
                
                elements.nonNegotiablesList.appendChild(itemEl);
            });
        }
        
        function renderModalList() {
            elements.modalList.innerHTML = '';
            
            state.nonNegotiables.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'modal-list-item';
                
                itemEl.innerHTML = `
                    <span>${item.text}</span>
                    <button class="delete-btn" data-id="${item.id}">🗑️</button>
                `;
                
                elements.modalList.appendChild(itemEl);
            });
        }
        
        // Audio & Notifications
        function initAudioContext() {
            if (!state.audioContext) {
                try {
                    state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (error) {
                    console.warn('Audio not supported:', error);
                }
            }
        }
        
        function playSoundNotification() {
            try {
                initAudioContext();
                if (!state.audioContext) return;
                
                const oscillator = state.audioContext.createOscillator();
                const gainNode = state.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(state.audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, state.audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, state.audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(800, state.audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.3, state.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, state.audioContext.currentTime + 0.3);
                
                oscillator.start(state.audioContext.currentTime);
                oscillator.stop(state.audioContext.currentTime + 0.3);
            } catch (error) {
                console.warn('Failed to play sound:', error);
            }
        }
        
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }
        
        function showNotification(title, body) {
            elements.notificationTitle.textContent = title;
            elements.notificationBody.textContent = body;
            elements.notification.classList.add('show');
            
            setTimeout(() => {
                elements.notification.classList.remove('show');
            }, 4000);
            
            if ('Notification' in window && Notification.permission === 'granted') {
                try {
                    new Notification(title, { body });
                } catch (error) {
                    console.warn('Browser notification failed:', error);
                }
            }
        }
        
        // Modal Functions
        function openSettingsModal() {
            elements.settingsModal.classList.add('show');
            renderModalList();
        }
        
        function closeSettingsModal() {
            elements.settingsModal.classList.remove('show');
        }
        
        // Event Listeners
        function setupEventListeners() {
            // Timer controls
            elements.startBtn.addEventListener('click', toggleTimer);
            elements.resetBtn.addEventListener('click', resetTimer);
            elements.skipBtn.addEventListener('click', skipPhase);
            
            // Tasks
            elements.addTaskBtn.addEventListener('click', addTask);
            elements.taskInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') addTask();
            });
            
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    state.activeTab = tab.dataset.tab;
                    renderTasks();
                });
            });
            
            // Task clicks and actions
            elements.taskList.addEventListener('click', e => {
                const taskItem = e.target.closest('.task-item');
                if (!taskItem) return;
                
                const taskId = taskItem.dataset.id;
                const action = e.target.dataset.action || e.target.closest('[data-action]')?.dataset.action;
                
                if (action === 'delete') {
                    deleteTask(taskId);
                } else if (action === 'move') {
                    openMoveModal(taskId);
                } else if (action === 'priority') {
                    changePriority(taskId);
                } else if (action === 'toggle') {
                    toggleTask(taskId);
                }
            });
            
            // Settings Modal
            elements.settingsBtn.addEventListener('click', openSettingsModal);
            elements.closeModal.addEventListener('click', closeSettingsModal);
            elements.settingsModal.addEventListener('click', e => {
                if (e.target === elements.settingsModal) closeSettingsModal();
            });
            
            elements.modalAddBtn.addEventListener('click', addNonNegotiable);
            elements.modalInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') addNonNegotiable();
            });
            
            elements.modalList.addEventListener('click', e => {
                if (e.target.closest('.delete-btn')) {
                    const itemId = e.target.dataset.id;
                    deleteNonNegotiable(itemId);
                }
            });
            
            // Move Modal
            elements.closeMoveModal.addEventListener('click', closeMoveModal);
            elements.moveModal.addEventListener('click', e => {
                if (e.target === elements.moveModal) closeMoveModal();
                
                if (e.target.closest('.move-option-btn')) {
                    const targetTab = e.target.dataset.target;
                    moveTaskTo(targetTab);
                }
            });
            
            // Non-negotiables clicks
            elements.nonNegotiablesList.addEventListener('click', e => {
                const item = e.target.closest('.non-negotiable-item');
                if (item) {
                    toggleNonNegotiable(item.dataset.id);
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', e => {
                if (document.activeElement.tagName === 'INPUT' || 
                    document.activeElement.tagName === 'SELECT') return;
                
                if (e.code === 'Space') {
                    e.preventDefault();
                    toggleTimer();
                }
                if (e.key === 'r' || e.key === 'R') {
                    e.preventDefault();
                    resetTimer();
                }
                if (e.key === 'Escape') {
                    if (elements.settingsModal.classList.contains('show')) {
                        closeSettingsModal();
                    }
                    if (elements.moveModal.classList.contains('show')) {
                        closeMoveModal();
                    }
                }
            });
            
            // Auto-save
            window.addEventListener('beforeunload', saveData);
            setInterval(saveData, 30000);
            
            // Check for new day every 10 minutes as backup
            setInterval(checkNewDay, 600000);
        }
        
        // Start the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
