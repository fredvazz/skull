<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skull Fuck Terminator</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíÄ</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #ffffff; overflow-x: hidden; }
        .container { display: flex; flex-direction: column; min-height: 100vh; width: 100%; padding: 20px; max-width: 1400px; margin: 0 auto; }
        
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 32px; margin-bottom: 8px; }
        .header p { color: #888; font-size: 16px; }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: #111111; border-radius: 12px; padding: 20px; border: 1px solid #222; }
        .stats-group { display: flex; gap: 40px; align-items: center; }
        .stat-item { text-align: center; }
        .stat-number { font-size: 36px; font-weight: 700; color: #ef4444; }
        .stat-label { font-size: 14px; color: #888; margin-top: 4px; }
        .streak-fire { font-size: 24px; margin-left: 5px; }
        .view-log-btn { padding: 12px 24px; background: #ef4444; color: #ffffff; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .view-log-btn:hover { background: #dc2626; }
        
        .timer-section { background: #111111; border-radius: 16px; padding: 40px; text-align: center; margin-bottom: 30px; border: 1px solid #222; }
        .phase-indicator { background: #ef4444; color: #ffffff; padding: 8px 20px; border-radius: 20px; font-size: 14px; font-weight: 600; display: inline-block; margin-bottom: 20px; }
        .timer-display { font-size: 72px; font-weight: 300; letter-spacing: -2px; margin-bottom: 10px; font-family: 'SF Mono', Monaco, monospace; }
        .next-phase { color: #888; font-size: 16px; margin-bottom: 30px; }
        .timer-controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: #ef4444; color: #ffffff; }
        .btn-primary:hover { background: #dc2626; }
        .btn-secondary { background: #333; color: #ffffff; }
        .btn-secondary:hover { background: #444; }
        .keyboard-hints { font-size: 12px; color: #666; }
        
        .tasks-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .task-list { background: #111111; border-radius: 16px; padding: 30px; border: 1px solid #222; }
        .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .task-title { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .task-icon { font-size: 16px; }
        .add-task { width: 100%; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 12px; color: #ffffff; font-size: 14px; margin-bottom: 20px; }
        .add-task::placeholder { color: #666; }
        .add-task:focus { outline: none; border-color: #ef4444; }
        .task-item { background: #1a1a1a; border-radius: 8px; padding: 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; transition: all 0.3s ease; cursor: pointer; }
        .task-item:hover { background: #222; }
        .task-item.completed { background: #0f0f0f; order: 1; }
        .task-checkbox { width: 18px; height: 18px; border: 2px solid #333; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; flex-shrink: 0; }
        .task-checkbox.checked { background: #ef4444; border-color: #ef4444; color: #ffffff; }
        .task-text { flex: 1; font-size: 14px; transition: all 0.3s ease; }
        .task-item.completed .task-text { color: #666; text-decoration: line-through; }
        .task-action { background: none; border: none; color: #666; cursor: pointer; font-size: 12px; padding: 4px 8px; border-radius: 4px; transition: all 0.3s ease; }
        .task-action:hover { background: #222; color: #ef4444; }
        .task-progress-container { margin-top: 15px; padding-top: 15px; border-top: 1px solid #222; }
        .task-progress-bar { width: 100%; height: 6px; background: #222; border-radius: 3px; overflow: hidden; margin-bottom: 8px; }
        .task-progress-fill { height: 100%; background: #ef4444; border-radius: 3px; transition: width 0.3s ease; }
        .task-progress-text { font-size: 11px; color: #888; text-align: center; }
        
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { background: #111111; border-radius: 16px; padding: 30px; width: 90%; max-width: 1200px; max-height: 85vh; overflow-y: auto; border: 1px solid #222; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 24px; font-weight: 600; }
        .close-btn { background: none; border: none; color: #888; cursor: pointer; font-size: 28px; padding: 5px; }
        .close-btn:hover { color: #ef4444; }
        
        .log-table-container { overflow-x: auto; border: 1px solid #333; border-radius: 8px; background: #0a0a0a; }
        .log-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .log-table th { background: #1a1a1a; color: #ef4444; padding: 12px; text-align: left; border-bottom: 2px solid #333; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        .log-table td { padding: 12px; border-bottom: 1px solid #222; }
        .log-table tr:hover { background: #151515; }
        .log-table tr.today-row { background: #1a0f0f; }
        .task-complete { color: #4ade80; }
        .task-incomplete { color: #666; }
        .month-header { background: #ef4444; color: #fff; font-weight: 600; }
        .month-summary { background: #1a1a1a; font-weight: 600; }
        .export-btn { padding: 8px 16px; background: #333; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin-bottom: 15px; }
        .export-btn:hover { background: #444; }
        
        .notification { position: fixed; top: 20px; right: 20px; background: #111111; border: 1px solid #ef4444; border-radius: 8px; padding: 15px 20px; color: #ffffff; z-index: 1002; max-width: 300px; transform: translateX(calc(100% + 40px)); transition: transform 0.3s ease; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); }
        .notification.show { transform: translateX(0); }
        .notification-title { font-weight: 600; margin-bottom: 5px; }
        .notification-body { font-size: 14px; color: #aaa; }
        
        @media (max-width: 768px) { 
            .tasks-section { grid-template-columns: 1fr; gap: 20px; }
            .timer-display { font-size: 48px; }
            .stats-group { flex-direction: column; gap: 15px; }
            .top-bar { flex-direction: column; gap: 20px; }
            .log-table { font-size: 12px; }
            .log-table th, .log-table td { padding: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Skull Fuck Terminator</h1>
            <p>Produtividade. Amplificada.</p>
        </header>

        <div class="top-bar">
            <div class="stats-group">
                <div class="stat-item">
                    <div class="stat-number" id="cycles-today">0</div>
                    <div class="stat-label">Ciclos Hoje</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="current-streak">0<span class="streak-fire">üî•</span></div>
                    <div class="stat-label">Dias Consecutivos</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="month-total">0</div>
                    <div class="stat-label">Ciclos Este M√™s</div>
                </div>
            </div>
            <button class="view-log-btn" id="view-log-btn">üìä Ver Registro Completo</button>
        </div>

        <section class="timer-section">
            <div class="phase-indicator" id="phase-indicator">Sess√£o de Foco</div>
            <div class="timer-display" id="timer-display">33:33</div>
            <div class="next-phase" id="next-phase">Pr√≥ximo: Descanso (6:37)</div>
            <div class="timer-controls">
                <button class="btn btn-primary" id="start-btn">‚ñ∂ Iniciar</button>
                <button class="btn btn-secondary" id="reset-btn">‚èπ Resetar</button>
                <button class="btn btn-secondary" id="skip-btn">‚è≠ Pular</button>
            </div>
            <div class="keyboard-hints">Pressione <strong>Espa√ßo</strong> para iniciar/pausar ‚Ä¢ <strong>R</strong> para resetar</div>
        </section>

        <section class="tasks-section">
            <div class="task-list">
                <div class="task-header">
                    <h2 class="task-title"><span class="task-icon">üìã</span> Tarefas do Dia</h2>
                    <button class="task-action" id="clear-completed-btn">Limpar Conclu√≠das</button>
                </div>
                <input type="text" class="add-task" id="add-task-input" placeholder="Adicionar nova tarefa...">
                <div id="do-today-list"></div>
                <div class="task-progress-container">
                    <div class="task-progress-bar"><div class="task-progress-fill" id="do-today-progress"></div></div>
                    <div class="task-progress-text" id="do-today-count">0 de 0 conclu√≠das</div>
                </div>
            </div>

            <div class="task-list">
                <div class="task-header">
                    <h2 class="task-title"><span class="task-icon">‚ö°</span> Inegoci√°veis Di√°rios</h2>
                </div>
                <div id="non-negotiables-list"></div>
                <div class="task-progress-container">
                    <div class="task-progress-bar"><div class="task-progress-fill" id="non-negotiables-progress"></div></div>
                    <div class="task-progress-text" id="non-negotiables-count">0 de 7 conclu√≠dos</div>
                </div>
            </div>
        </section>
    </div>

    <div class="modal" id="log-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìä Registro de Produtividade</h2>
                <button class="close-btn" id="close-log-modal">√ó</button>
            </div>
            <button class="export-btn" id="export-btn">üì• Exportar para CSV</button>
            <div class="log-table-container">
                <table class="log-table" id="log-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Dia</th>
                            <th>Ciclos</th>
                            <th>Reels</th>
                            <th>Stories</th>
                            <th>DM</th>
                            <th>AI/Product</th>
                            <th>Medita√ß√£o</th>
                            <th>Surf/Treino</th>
                            <th>Leitura</th>
                            <th>Tarefas</th>
                        </tr>
                    </thead>
                    <tbody id="log-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <div class="notification-title" id="notification-title"></div>
        <div class="notification-body" id="notification-body"></div>
    </div>

    <script>
        'use strict';
        
        // --- APPLICATION STATE ---
        let state = {
            currentTime: 33 * 60 + 33,
            isRunning: false,
            isRestPhase: false,
            timerInterval: null,
            cyclesCompleted: 0,
            doTodayTasks: [],
            nonNegotiables: [
                { id: 'reels', text: '1 Reels', completed: false },
                { id: 'stories', text: '1 Stories Sequence / Single Insight', completed: false },
                { id: 'dm', text: '1/2 Cicles DM Clients / Followers', completed: false },
                { id: 'ai', text: '1/2 Cicles AI Knowledge / Product Building', completed: false },
                { id: 'meditation', text: 'Joe Dispenza Meditation', completed: false },
                { id: 'surf', text: 'Surf Workout / Session', completed: false },
                { id: 'reading', text: 'Reading', completed: false }
            ],
            history: {},
            audioContext: null,
            currentStreak: 0,
            monthTotal: 0
        };
        
        const FOCUS_TIME = 33 * 60 + 33;
        const REST_TIME = 6 * 60 + 37;

        // --- DOM ELEMENTS ---
        const elements = {
            cyclesToday: document.getElementById('cycles-today'),
            currentStreak: document.getElementById('current-streak'),
            monthTotal: document.getElementById('month-total'),
            viewLogBtn: document.getElementById('view-log-btn'),
            phaseIndicator: document.getElementById('phase-indicator'),
            timerDisplay: document.getElementById('timer-display'),
            nextPhase: document.getElementById('next-phase'),
            startBtn: document.getElementById('start-btn'),
            resetBtn: document.getElementById('reset-btn'),
            skipBtn: document.getElementById('skip-btn'),
            clearCompletedBtn: document.getElementById('clear-completed-btn'),
            addTaskInput: document.getElementById('add-task-input'),
            doTodayList: document.getElementById('do-today-list'),
            doTodayProgress: document.getElementById('do-today-progress'),
            doTodayCount: document.getElementById('do-today-count'),
            nonNegotiablesList: document.getElementById('non-negotiables-list'),
            nonNegotiablesProgress: document.getElementById('non-negotiables-progress'),
            nonNegotiablesCount: document.getElementById('non-negotiables-count'),
            notification: document.getElementById('notification'),
            notificationTitle: document.getElementById('notification-title'),
            notificationBody: document.getElementById('notification-body'),
            logModal: document.getElementById('log-modal'),
            closeLogModal: document.getElementById('close-log-modal'),
            logTableBody: document.getElementById('log-table-body'),
            exportBtn: document.getElementById('export-btn')
        };

        // --- UTILITY FUNCTIONS ---
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function getTodayString() {
            return new Date().toDateString();
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function getDayName(dateStr) {
            const date = new Date(dateStr);
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            return days[date.getDay()];
        }

        // --- INITIALIZATION ---
        function init() {
            loadData();
            checkNewDay();
            updateTimerDisplay();
            updateStats();
            renderAllTasks();
            setupEventListeners();
            requestNotificationPermission();
            calculateStreak();
            calculateMonthTotal();
        }

        function saveData() {
            try {
                const dataToSave = { 
                    ...state, 
                    timerInterval: null,
                    audioContext: null
                };
                localStorage.setItem('skull-terminator-v2-data', JSON.stringify(dataToSave));
            } catch (error) {
                console.error('Failed to save data:', error);
            }
        }

        function loadData() {
            try {
                const savedData = localStorage.getItem('skull-terminator-v2-data');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    state = { ...state, ...parsedData };
                    state.isRunning = false;
                    state.timerInterval = null;
                    state.audioContext = null;
                    
                    // Reset non-negotiables to ensure they're always the same
                    state.nonNegotiables = [
                        { id: 'reels', text: '1 Reels', completed: false },
                        { id: 'stories', text: '1 Stories Sequence / Single Insight', completed: false },
                        { id: 'dm', text: '1/2 Cicles DM Clients / Followers', completed: false },
                        { id: 'ai', text: '1/2 Cicles AI Knowledge / Product Building', completed: false },
                        { id: 'meditation', text: 'Joe Dispenza Meditation', completed: false },
                        { id: 'surf', text: 'Surf Workout / Session', completed: false },
                        { id: 'reading', text: 'Reading', completed: false }
                    ];
                }
            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }

        function checkNewDay() {
            const todayStr = getTodayString();
            if (!state.history[todayStr]) {
                state.history[todayStr] = {
                    cycles: 0,
                    tasks: [],
                    nonNegotiables: {}
                };
            }
            
            const todayData = state.history[todayStr];
            state.cyclesCompleted = todayData.cycles || 0;
            state.doTodayTasks = todayData.tasks || [];
            
            // Load today's non-negotiables status
            state.nonNegotiables.forEach(item => {
                item.completed = todayData.nonNegotiables[item.id] || false;
            });
        }

        // --- TIMER FUNCTIONS ---
        function toggleTimer() {
            if (!state.isRunning) {
                startTimer();
            } else {
                pauseTimer();
            }
        }

        function startTimer() {
            state.isRunning = true;
            elements.startBtn.innerHTML = '‚è∏ Pausar';
            state.timerInterval = setInterval(() => {
                state.currentTime--;
                if (state.currentTime < 0) {
                    completePhase();
                } else {
                    updateTimerDisplay();
                }
            }, 1000);
        }

        function pauseTimer() {
            state.isRunning = false;
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
            elements.startBtn.innerHTML = '‚ñ∂ Iniciar';
        }

        function resetTimer() {
            pauseTimer();
            state.currentTime = state.isRestPhase ? REST_TIME : FOCUS_TIME;
            updateTimerDisplay();
        }

        function skipPhase() {
            pauseTimer();
            completePhase();
        }

        function completePhase() {
            const todayStr = getTodayString();
            
            playSoundNotification();

            if (state.isRestPhase) {
                state.cyclesCompleted++;
                state.history[todayStr].cycles = state.cyclesCompleted;
                state.isRestPhase = false;
                state.currentTime = FOCUS_TIME;
                showInAppNotification('üî• Ciclo Completo!', `Voc√™ completou ${state.cyclesCompleted} ciclos hoje.`);
            } else {
                state.isRestPhase = true;
                state.currentTime = REST_TIME;
                showInAppNotification('üòå Hora de Descansar!', 'Boa sess√£o de foco! Fa√ßa uma pausa.');
            }
            
            updateTimerDisplay();
            updateStats();
            saveData();
            
            state.isRunning = false;
            elements.startBtn.innerHTML = '‚ñ∂ Iniciar';
        }

        // --- AUDIO ---
        function initAudioContext() {
            if (!state.audioContext) {
                try {
                    state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (error) {
                    console.warn('Audio context not supported:', error);
                }
            }
        }

        function playSoundNotification() {
            try {
                initAudioContext();
                if (!state.audioContext) return;

                const oscillator = state.audioContext.createOscillator();
                const gainNode = state.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(state.audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, state.audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, state.audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(800, state.audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.3, state.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, state.audioContext.currentTime + 0.3);
                
                oscillator.start(state.audioContext.currentTime);
                oscillator.stop(state.audioContext.currentTime + 0.3);
            } catch (error) {
                console.warn('Failed to play sound:', error);
            }
        }

        // --- DISPLAY FUNCTIONS ---
        function updateTimerDisplay() {
            const timeString = formatTime(state.currentTime);
            elements.timerDisplay.textContent = timeString;
            document.title = `${timeString} - ${state.isRestPhase ? 'Descanso' : 'Foco'}`;
            elements.phaseIndicator.textContent = state.isRestPhase ? 'Sess√£o de Descanso' : 'Sess√£o de Foco';
            elements.nextPhase.textContent = state.isRestPhase ? 
                `Pr√≥ximo: Foco (${formatTime(FOCUS_TIME)})` : 
                `Pr√≥ximo: Descanso (${formatTime(REST_TIME)})`;
        }

        function updateStats() {
            elements.cyclesToday.textContent = state.cyclesCompleted;
            calculateStreak();
            calculateMonthTotal();
        }

        function calculateStreak() {
            const dates = Object.keys(state.history).sort((a, b) => new Date(b) - new Date(a));
            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let i = 0; i < dates.length; i++) {
                const date = new Date(dates[i]);
                date.setHours(0, 0, 0, 0);
                const dayDiff = Math.floor((today - date) / (1000 * 60 * 60 * 24));
                
                if (dayDiff === streak && state.history[dates[i]].cycles > 0) {
                    streak++;
                } else if (dayDiff > streak) {
                    break;
                }
            }
            
            state.currentStreak = streak;
            elements.currentStreak.innerHTML = `${streak}<span class="streak-fire">üî•</span>`;
        }

        function calculateMonthTotal() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            let total = 0;
            Object.keys(state.history).forEach(dateStr => {
                const date = new Date(dateStr);
                if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
                    total += state.history[dateStr].cycles || 0;
                }
            });
            
            state.monthTotal = total;
            elements.monthTotal.textContent = total;
        }

        // --- TASK MANAGEMENT ---
        function renderAllTasks() {
            renderDoToday();
            renderNonNegotiables();
        }

        function renderDoToday() {
            elements.doTodayList.innerHTML = '';
            const sortedTasks = [...state.doTodayTasks].sort((a, b) => a.completed - b.completed);
            
            sortedTasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = `task-item ${task.completed ? 'completed' : ''}`;
                taskItem.dataset.id = task.id;
                
                const checkbox = document.createElement('div');
                checkbox.className = `task-checkbox ${task.completed ? 'checked' : ''}`;
                checkbox.innerHTML = task.completed ? '‚úì' : '';
                
                const text = document.createElement('div');
                text.className = 'task-text';
                text.textContent = task.text;
                
                taskItem.appendChild(checkbox);
                taskItem.appendChild(text);
                elements.doTodayList.appendChild(taskItem);
            });
            
            updateTaskProgress();
        }

        function renderNonNegotiables() {
            elements.nonNegotiablesList.innerHTML = '';
            
            state.nonNegotiables.forEach(item => {
                const taskItem = document.createElement('div');
                taskItem.className = `task-item ${item.completed ? 'completed' : ''}`;
                taskItem.dataset.id = item.id;
                
                const checkbox = document.createElement('div');
                checkbox.className = `task-checkbox ${item.completed ? 'checked' : ''}`;
                checkbox.innerHTML = item.completed ? '‚úì' : '';
                
                const text = document.createElement('div');
                text.className = 'task-text';
                text.textContent = item.text;
                
                taskItem.appendChild(checkbox);
                taskItem.appendChild(text);
                elements.nonNegotiablesList.appendChild(taskItem);
            });
            
            updateNonNegotiablesProgress();
        }

        function updateTaskProgress() {
            const total = state.doTodayTasks.length;
            const completed = state.doTodayTasks.filter(t => t.completed).length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            elements.doTodayCount.textContent = `${completed} de ${total} conclu√≠das`;
            elements.doTodayProgress.style.width = `${percentage}%`;
        }

        function updateNonNegotiablesProgress() {
            const total = state.nonNegotiables.length;
            const completed = state.nonNegotiables.filter(n => n.completed).length;
            const percentage = Math.round((completed / total) * 100);
            elements.nonNegotiablesCount.textContent = `${completed} de ${total} conclu√≠dos`;
            elements.nonNegotiablesProgress.style.width = `${percentage}%`;
        }

        function addDoTodayTask() {
            const text = elements.addTaskInput.value.trim();
            if (text && text.length <= 200) {
                const todayStr = getTodayString();
                const task = { id: generateUniqueId(), text, completed: false };
                state.doTodayTasks.push(task);
                state.history[todayStr].tasks = state.doTodayTasks;
                elements.addTaskInput.value = '';
                renderDoToday();
                saveData();
            }
        }

        function toggleDoTodayTask(taskId) {
            const task = state.doTodayTasks.find(t => t.id === taskId);
            if (task) {
                const todayStr = getTodayString();
                task.completed = !task.completed;
                if (task.completed) {
                    showInAppNotification('‚úÖ Tarefa Conclu√≠da!', `"${task.text}" - Bom trabalho!`);
                }
                state.history[todayStr].tasks = state.doTodayTasks;
                renderDoToday();
                saveData();
            }
        }

        function toggleNonNegotiable(id) {
            const item = state.nonNegotiables.find(n => n.id === id);
            if (item) {
                const todayStr = getTodayString();
                item.completed = !item.completed;
                state.history[todayStr].nonNegotiables[id] = item.completed;
                if (item.completed) {
                    showInAppNotification('‚ö° Inegoci√°vel Feito!', `"${item.text}" - Voc√™ √© impar√°vel!`);
                }
                renderNonNegotiables();
                saveData();
            }
        }

        function clearCompletedTasks() {
            const todayStr = getTodayString();
            state.doTodayTasks = state.doTodayTasks.filter(task => !task.completed);
            state.history[todayStr].tasks = state.doTodayTasks;
            renderDoToday();
            saveData();
        }

        // --- LOG TABLE FUNCTIONS ---
        function showLogModal() {
            renderLogTable();
            elements.logModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLogModal() {
            elements.logModal.classList.remove('active');
            document.body.style.overflow = '';
        }

        function renderLogTable() {
            elements.logTableBody.innerHTML = '';
            const sortedDates = Object.keys(state.history).sort((a, b) => new Date(b) - new Date(a));
            
            let currentMonth = null;
            let monthCycles = 0;
            let monthDays = 0;
            
            sortedDates.forEach(dateStr => {
                const date = new Date(dateStr);
                const month = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                const dayData = state.history[dateStr];
                
                // Add month header if new month
                if (month !== currentMonth) {
                    if (currentMonth !== null) {
                        // Add month summary row
                        const summaryRow = document.createElement('tr');
                        summaryRow.className = 'month-summary';
                        summaryRow.innerHTML = `
                            <td colspan="3">Total do M√™s</td>
                            <td colspan="7">${monthCycles} ciclos em ${monthDays} dias</td>
                        `;
                        elements.logTableBody.appendChild(summaryRow);
                    }
                    
                    currentMonth = month;
                    monthCycles = 0;
                    monthDays = 0;
                    
                    const monthRow = document.createElement('tr');
                    monthRow.className = 'month-header';
                    monthRow.innerHTML = `<td colspan="10">${month}</td>`;
                    elements.logTableBody.appendChild(monthRow);
                }
                
                monthCycles += dayData.cycles || 0;
                if (dayData.cycles > 0) monthDays++;
                
                const row = document.createElement('tr');
                const isToday = dateStr === getTodayString();
                if (isToday) row.className = 'today-row';
                
                const completedTasks = (dayData.tasks || []).filter(t => t.completed).length;
                const totalTasks = (dayData.tasks || []).length;
                
                row.innerHTML = `
                    <td>${formatDate(dateStr)}</td>
                    <td>${getDayName(dateStr)}</td>
                    <td><strong>${dayData.cycles || 0}</strong></td>
                    <td>${dayData.nonNegotiables?.reels ? '‚úÖ' : '‚¨ú'}</td>
                    <td>${dayData.nonNegotiables?.stories ? '‚úÖ' : '‚¨ú'}</td>
                    <td>${dayData.nonNegotiables?.dm ? '‚úÖ' : '‚¨ú'}</td>
                    <td>${dayData.nonNegotiables?.ai ? '‚úÖ' : '‚¨ú'}</td>
                    <td>${dayData.nonNegotiables?.meditation ? '‚úÖ' : '‚¨ú'}</td>
                    <td>${dayData.nonNegotiables?.surf ? '‚úÖ' : '‚¨ú'}</td>
                    <td>${dayData.nonNegotiables?.reading ? '‚úÖ' : '‚¨ú'}</td>
                    <td>${completedTasks}/${totalTasks}</td>
                `;
                
                elements.logTableBody.appendChild(row);
            });
            
            // Add final month summary
            if (currentMonth !== null) {
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'month-summary';
                summaryRow.innerHTML = `
                    <td colspan="3">Total do M√™s</td>
                    <td colspan="7">${monthCycles} ciclos em ${monthDays} dias</td>
                `;
                elements.logTableBody.appendChild(summaryRow);
            }
        }

        function exportToCSV() {
            const headers = ['Data', 'Dia', 'Ciclos', 'Reels', 'Stories', 'DM', 'AI/Product', 'Medita√ß√£o', 'Surf/Treino', 'Leitura', 'Tarefas Completas'];
            const rows = [];
            
            const sortedDates = Object.keys(state.history).sort((a, b) => new Date(b) - new Date(a));
            
            sortedDates.forEach(dateStr => {
                const dayData = state.history[dateStr];
                const completedTasks = (dayData.tasks || []).filter(t => t.completed).length;
                const totalTasks = (dayData.tasks || []).length;
                
                rows.push([
                    formatDate(dateStr),
                    getDayName(dateStr),
                    dayData.cycles || 0,
                    dayData.nonNegotiables?.reels ? 'Sim' : 'N√£o',
                    dayData.nonNegotiables?.stories ? 'Sim' : 'N√£o',
                    dayData.nonNegotiables?.dm ? 'Sim' : 'N√£o',
                    dayData.nonNegotiables?.ai ? 'Sim' : 'N√£o',
                    dayData.nonNegotiables?.meditation ? 'Sim' : 'N√£o',
                    dayData.nonNegotiables?.surf ? 'Sim' : 'N√£o',
                    dayData.nonNegotiables?.reading ? 'Sim' : 'N√£o',
                    `${completedTasks}/${totalTasks}`
                ]);
            });
            
            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `productivity_log_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- NOTIFICATIONS ---
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function showInAppNotification(title, body) {
            elements.notificationTitle.textContent = title;
            elements.notificationBody.textContent = body;
            elements.notification.classList.add('show');
            
            setTimeout(() => {
                elements.notification.classList.remove('show');
            }, 4000);
            
            // Also try browser notification
            if ('Notification' in window && Notification.permission === 'granted') {
                try {
                    new Notification(title, { 
                        body, 
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üíÄ</text></svg>'
                    });
                } catch (error) {
                    console.warn('Failed to show notification:', error);
                }
            }
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            // Timer controls
            elements.startBtn.addEventListener('click', toggleTimer);
            elements.resetBtn.addEventListener('click', resetTimer);
            elements.skipBtn.addEventListener('click', skipPhase);

            // Task controls
            elements.addTaskInput.addEventListener('keypress', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addDoTodayTask();
                }
            });
            elements.clearCompletedBtn.addEventListener('click', clearCompletedTasks);

            // Task clicking
            elements.doTodayList.addEventListener('click', e => {
                const taskItem = e.target.closest('.task-item');
                if (taskItem) {
                    toggleDoTodayTask(taskItem.dataset.id);
                }
            });

            elements.nonNegotiablesList.addEventListener('click', e => {
                const taskItem = e.target.closest('.task-item');
                if (taskItem) {
                    toggleNonNegotiable(taskItem.dataset.id);
                }
            });

            // Log modal
            elements.viewLogBtn.addEventListener('click', showLogModal);
            elements.closeLogModal.addEventListener('click', closeLogModal);
            elements.exportBtn.addEventListener('click', exportToCSV);
            
            elements.logModal.addEventListener('click', e => {
                if (e.target === elements.logModal) {
                    closeLogModal();
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', e => {
                if (document.activeElement.tagName === 'INPUT' || 
                    elements.logModal.classList.contains('active')) {
                    return;
                }
                
                if (e.code === 'Space') { 
                    e.preventDefault(); 
                    toggleTimer(); 
                }
                if (e.key === 'r' || e.key === 'R') {
                    e.preventDefault();
                    resetTimer();
                }
            });

            // Notification click to dismiss
            elements.notification.addEventListener('click', () => {
                elements.notification.classList.remove('show');
            });

            // Auto-save
            window.addEventListener('beforeunload', saveData);
            setInterval(saveData, 30000); // Auto-save every 30 seconds
            
            // Periodic stats update
            setInterval(() => {
                checkNewDay();
                updateStats();
            }, 60000); // Check every minute
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
